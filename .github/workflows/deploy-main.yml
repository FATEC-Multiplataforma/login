name: Fretec Deploy

on:
  push:
    branches:
      - main
      - develop

jobs:
  security:
    name: Scan for Vulnerabilities
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'zulu'

      - name: Build project (without tests)
        run: mvn clean install -DskipTests

      - name: Install Trivy
        run: |
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      - name: Scan for vulnerabilities in dependencies (Maven)
        run: |
          trivy fs \
            --scanners vuln \
            --vuln-type library \
            --severity CRITICAL,HIGH \
            --exit-code 1 \
            --ignore-unfixed \
            --format table \
            .

#  quality:
#    name: Quality
#    runs-on: ubuntu-latest
#    needs: security
#    steps:
#      - name: Checkout repository
#        uses: actions/checkout@v3
#        with:
#          fetch-depth: 0
#
#      - name: Set up JDK 17
#        uses: actions/setup-java@v3
#        with:
#          java-version: '17'
#          distribution: 'zulu'
#
#      - name: Cache Maven packages
#        uses: actions/cache@v3
#        with:
#          path: ~/.m2/repository
#          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
#          restore-keys: ${{ runner.os }}-maven
#
#      - name: Build with Maven
#        run: mvn clean verify
#
#      - name: SonarCloud Scan
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        run: |
#          mvn sonar:sonar \
#            -Dsonar.projectKey=FATEC-Multiplataforma_login \
#            -Dsonar.organization=fatec-multiplataforma  \
#            -Dsonar.host.url=https://sonarcloud.io \
#            -Dsonar.login=${{ secrets.SONAR_TOKEN }}

#      - name: List generated files (for debugging)
#        run: ls -l springframework/target/jacoco-report/
#
#      - name: SonarCloud Scan
#        env:
#          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
#        run: |
#          mvn sonar:sonar \
#            -Dsonar.projectKey=fatec-multiplataforma_login \
#            -Dsonar.organization=fatec-multiplataforma \
#            -Dsonar.host.url=https://sonarcloud.io \
#            -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
#            -Dsonar.coverage.jacoco.xmlReportPaths=springframework/target/jacoco-report/jacoco.xml

#      - name: Check SonarQube results
#        run: |
#          SONAR_URL="https://sonarcloud.io/api/measures/component?componentKey=cisp-it_iam-management&branch=main"
#
#          CODE_SMELL=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: "$SONAR_URL&metricKeys=code_smells" | jq -r '.component.measures[0].value')
#          if [ "$CODE_SMELL" -gt 10 ]; then
#            echo "Aplicação com mais de 10 code small."
#            exit 1
#          fi
#          DUPLICATED=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: "$SONAR_URL&metricKeys=duplicated_lines_density" | jq -r '.component.measures[0].value')
#          if (( $(echo "$DUPLICATED > 14.0" | bc -l) )); then
#            echo "Aplicação com mais de 3% de duplicação de código."
#            exit 1
#          fi
#          NUM_BUGS=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: "$SONAR_URL&metricKeys=bugs" | jq -r '.component.measures[0].value')
#          if [ "$NUM_BUGS" -gt 2 ]; then
#            echo "Aplicação contem mais de 2 bugs."
#            exit 1
#          fi
#          COVER=$(curl -s -u ${{ secrets.SONAR_TOKEN }}: "$SONAR_URL&metricKeys=coverage" | jq -r '.component.measures[0].value')
#          if (( $(echo "$COVER < 80.0" | bc -l) )); then
#            echo "Aplicação com menos de 80% de coverage."
#            exit 1
#          fi

#  deploy:
#    runs-on: ubuntu-latest
#
#    steps:
#      - name: Verificar Versao
#        uses: actions/checkout@v5
#
#      - name: Setup Java
#        uses: actions/setup-java@v2
#        with:
#          distribution: 'temurin'
#          java-version: 17
#
#      - name: Download Wrapper
#        run: mvn -N io.takari:maven:wrapper -Dmaven=3.9.9
#
#      - name: Build Projeto
#        run: mvn clean install -Dmaven.test.skip
#
#      - name: Dockerhub Integration
#        uses: docker/login-action@v2
#        with:
#          username: ${{ secrets.DOCKER_USERNAME }}
#          password: ${{ secrets.DOCKER_PASSWORD }}
#
#      - name: Build Imagem
#        run: docker build -t mrspock182/login:latest .
#
#      - name: Deploy Dockerhub
#        run: docker push mrspock182/login:latest